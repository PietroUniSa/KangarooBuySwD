name: CI Pipeline for Kangaroo App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  test:
    name: Unit/Integration Tests (Maven + MySQL)
    runs-on: ubuntu-latest

    services:
      db:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: kangaroodb
          MYSQL_USER: kangaroo
          MYSQL_PASSWORD: kangaroo
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3307:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -uroot -proot"
          --health-timeout=10s
          --health-retries=5
        # Se la tua configurazione "volumes" funziona giÃ  per te, lasciala.
        # In caso di errori, rimuovi volumes (su GitHub Actions spesso non serve).
        # volumes:
        #   - ./initdb:/docker-entrypoint-initdb.d

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java (Temurin 21) + Maven cache
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Create upload directory (/var/kangaroo_uploads)
        run: |
          sudo mkdir -p /var/kangaroo_uploads
          sudo chmod -R 777 /var/kangaroo_uploads

      - name: Install Dependencies (skip tests)
        run: mvn -B clean install -DskipTests

      - name: Run Tests
        run: mvn -B test

  gitguardian:
    name: GitGuardian secret scan
    runs-on: ubuntu-latest
    needs: [ test ]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets (ggshield)
        uses: GitGuardian/ggshield-action@v1
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  snyk:
    name: Snyk dependency scan (Maven)
    runs-on: ubuntu-latest
    needs: [ test ]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Build (required for some projects)
        run: mvn -B -DskipTests package

      - name: Snyk test (fail on High/Critical)
        uses: snyk/actions/maven@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --fail-on=all

  sonarqube:
    name: SonarQube scan + Quality Gate
    runs-on: ubuntu-latest
    needs: [ test ]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: SonarQube analyze (wait for Quality Gate)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: >
          mvn -B verify sonar:sonar
          -Dsonar.host.url=${SONAR_HOST_URL}
          -Dsonar.login=${SONAR_TOKEN}
          -Dsonar.qualitygate.wait=true
