name: CI Pipeline for Kangaroo App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Unit/Integration Tests (Maven + MySQL)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    services:
      db:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: kangaroodb
          MYSQL_USER: kangaroo
          MYSQL_PASSWORD: kangaroo
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3307:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -uroot -proot"
          --health-timeout=10s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java (Temurin 21) + Maven cache
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Create upload directory (/var/kangaroo_uploads)
        run: |
          sudo mkdir -p /var/kangaroo_uploads
          sudo chmod -R 777 /var/kangaroo_uploads

      - name: Install Dependencies (skip tests)
        run: mvn -B clean install -DskipTests

      - name: Run Tests
        run: mvn -B test

  gitguardian:
    name: GitGuardian secret scan
    runs-on: ubuntu-latest
    needs: [ test ]
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets (ggshield)
        uses: GitGuardian/ggshield-action@v1
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  snyk:
    name: Snyk dependency scan (Maven)
    runs-on: ubuntu-latest
    needs: [ test ]
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build (required for some projects)
        run: mvn -B -DskipTests package

      - name: Snyk test (fail on High/Critical)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 20
          command: |
            docker pull snyk/snyk:maven
            docker run --rm \
              -e SNYK_TOKEN="${{ secrets.SNYK_TOKEN }}" \
              -v "${PWD}:/project" -w /project \
              snyk/snyk:maven \
              snyk test --severity-threshold=high --fail-on=all

  sonarqube:
    name: SonarCloud scan + Quality Gate
    runs-on: ubuntu-latest
    needs: [ test ]
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: SonarCloud analyze (wait for Quality Gate)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B -DskipTests clean package org.sonarsource.scanner.maven:sonar-maven-plugin:5.5.0.6356:sonar \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.organization=pietro05032003 \
            -Dsonar.projectKey=PietroUniSa_KangarooBuySwD \
            -Dsonar.branch.name=main \
            -Dsonar.qualitygate.wait=true
